name: Nix Flake Update

on:
  schedule:
    - cron: "0 7 * * 1"
  workflow_dispatch:

permissions:
permissions:
  contents: write   # needed by peter-evans/create-pull-request to push the branch
  pull-requests: write
  pull-requests: write

concurrency:
  group: nix-flake-update
  cancel-in-progress: false

jobs:
  update-flake-lock:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          fetch-depth: 1
          fetch-depth: 0

      - name: Validate Cachix configuration
        env:
          CACHIX_CACHE_NAME: ${{ vars.CACHIX_CACHE_NAME }}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        run: |
          set -euo pipefail
          : "${CACHIX_CACHE_NAME:?Repository variable CACHIX_CACHE_NAME is required.}"
          : "${CACHIX_AUTH_TOKEN:?Repository secret CACHIX_AUTH_TOKEN is required.}"

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Configure Cachix
        uses: cachix/cachix-action@v16
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Update flake lock
        run: |
          set -euo pipefail
          nix flake update --accept-flake-config

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(nix): update flake.lock"
          title: "chore(nix): update flake.lock"
          body: |
            ## Summary
            - update `flake.lock` with latest versions for all flake inputs
            - generated by scheduled Nix dependency automation

            ## Notes
            - uses Cachix cache `${{ vars.CACHIX_CACHE_NAME }}`
            - no auto-merge; manual review required
          branch: "chore/nix-flake-update"
          delete-branch: true
          add-paths: |
            flake.lock
          labels: |
            dependencies
            type:chore
            area:ci
