name: Remote Integration

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Remote deployment base URL (for example: https://rin-server-pr-9.example.workers.dev)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  remote-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Resolve remote test config
        id: config
        run: |
          ENABLED="${{ vars.ENABLE_REMOTE_INTEGRATION_TESTS }}"
          BASE_URL="${{ github.event.inputs.base_url }}"

          if [ -z "$BASE_URL" ]; then
            BASE_URL="${{ vars.RIN_REMOTE_BASE_URL }}"
          fi

          echo "enabled=$ENABLED" >> "$GITHUB_OUTPUT"
          echo "base_url=$BASE_URL" >> "$GITHUB_OUTPUT"

      - name: Remote tests disabled
        if: ${{ steps.config.outputs.enabled != 'true' }}
        run: |
          echo "Skipping remote tests: set repo variable ENABLE_REMOTE_INTEGRATION_TESTS=true to enable."

      - name: Missing remote base URL
        if: ${{ steps.config.outputs.enabled == 'true' && steps.config.outputs.base_url == '' }}
        run: |
          echo "Remote tests enabled but no URL configured."
          echo "Set workflow_dispatch input 'base_url' or repo variable RIN_REMOTE_BASE_URL."
          exit 1

      - name: Run remote integration tests
        if: ${{ steps.config.outputs.enabled == 'true' && steps.config.outputs.base_url != '' }}
        env:
          ENABLE_REMOTE_INTEGRATION_TESTS: 'true'
          RIN_REMOTE_BASE_URL: ${{ steps.config.outputs.base_url }}
          RIN_REMOTE_AUTH_TOKEN: ${{ secrets.RIN_REMOTE_AUTH_TOKEN }}
        run: bun run test:remote
